## minipbjs —— pbjs like tool focus on code size reduction

### [中文说明](https://github.com/mustime/minipbjs/blob/main/README.zh-CN.md)

------

**minipbjs** is a command line tool based on `pbjs` from [protobuf.js](https://github.com/protobufjs/protobuf.js) project, which targets on minimizing the generated javascript code while keeping the same functionality. Compatible to `Node.js`, browsers, wechat miniprogram and other instant-games. Making it perfectly suitable for the scenarios like wechat miniprogram which requires code size restrictions.

## Installation & Example

------

### installing

```bash
# install `minipbjs` globally with option -g
$> npm install minipbjs -g
```

### Generating Javascript code

```bash
# With same usage with pbjs
$> minipbjs --keep-case # Keeps field casing instead of converting to camel case.
            --root PB   # Specifies an alternative protobuf.roots name.
            # Adds a directory to the include path. Following with target protofiles
            --path /path/to/protofiles a.proto b.proto c.proto ...
            # Notice: --out option in pbjs refers to a file, but it refers to a dir in minipbjs
            --out /path/to/protobuf-bundles/
            # Additional options in minipbjs:
            #   --name Specifies the output Javascript filename,'protobuf-bundles' by default.
            --name protobuf-bundles-mini

# Automatically generates Javascript files specified with --name options.
# Along with the uglified min.js.
$> ls -al /path/to/protobuf-bundles/
 > -rw-r--r--   1 mustime staff  xxxx  protobuf-bundles-mini.js
 > -rw-r--r--   1 mustime staff  xxxx  protobuf-bundles-mini.min.js
 
```

### Using in program

```javascript
// require the necessary protobuf-library first
require('protobuf-library.js');
require('protobuf-bundles-mini.js');

// a simple test(PB variable is specified by `--root PB` option)
var foo = PB.foo.Foo.create({ 'a': 1, 'b': 'test' });
var bytes = PB.foo.Foo.encode(foo).finish();
var foo2 = PB.foo.Foo.decode(bytes);

// they should print the same
console.log(foo.a, foo2.a);
console.log(foo.b, foo2.b);

// see futher tests under 'minipbjs/tests'
```



## Comparison with pbjs

------

### Under the hood

The Javascript static code generated by `pbjs --target static` contains  `constructor`/`create`/`encode`/`decode` function stubs for **each** message. They are created base on the specific message structure so that they are distinguish to each other and unlikely able to share with other messages.

However, `minipbjs` puts basic info from each message(id, name, default value, options, etc.) into a single map. And providing major functionality(currently supports `create`/`encode`/`decode`/`encodeDelimited`/`decodeDelimited`) as shared implements for all message.

### Comparison

Take my recent project as example, which is a wechat minigame contains more than 2500 message. On my 2019 RMBP-15, it costs more than 40s to run `pbjs --target static`, resulting in a 5.2m min.js file. Meanwhile, running with `minipbjs`(remove `--target static` option as well, or minipbjs will perform the same as pbjs) costs only 1.6s, resulting with a 160kB min.js.

## Liscense

------

This project is liscensed under `The MIT Liscense`. 

Enjoy. [Let me know](https://github.com/mustime/minipbjs/issues) if you have any suggestion or encountering with any problem : ).